// ==========================================
// CONFIG
// ==========================================
const API_URL = "http://localhost:3000";

document.addEventListener("DOMContentLoaded", cargarDetalle);

// ==========================================
// CARGAR DETALLE DE RECETA
// ==========================================
async function cargarDetalle() {
    const params = new URLSearchParams(window.location.search);
    const id = params.get("id");

    if (!id) return mostrarError("No se encontró la receta.");

    try {
        const res = await fetch(`${API_URL}/recetas/${id}`);
        if (!res.ok) return mostrarError("No se pudo obtener la receta.");

        const receta = await res.json();

        rellenarPagina(receta);
        activarBotonAgregar(receta);

    } catch (err) {
        console.error(err);
        mostrarError("Error al conectar con el servidor.");
    }
}

// ==========================================
// RELLENAR HTML
// ==========================================
function rellenarPagina(r) {
    document.getElementById("tituloReceta").textContent = r.titulo || "";
    document.getElementById("autorReceta").textContent = r.autorNombre || "Autor desconocido";
    document.getElementById("categoriaReceta").textContent = r.categoria || "Sin categoría";
    document.getElementById("complejidadReceta").textContent = r.complejidad || "N/A";
    document.getElementById("porcionesReceta").textContent = r.porciones || "N/A";
    document.getElementById("tiempoReceta").textContent = r.tiempoPreparacionMin || "N/A";

    // Imagen
    const img = document.getElementById("imagenPrincipal");
    img.src = r.imagenPrincipal ? `${API_URL}/${r.imagenPrincipal}` : "imgs/default.jpg";

    // Descripción
    document.getElementById("descripcionReceta").textContent = r.descripcion || "";

    // Ingredientes
    const listaIng = document.getElementById("listaIngredientes");
    listaIng.innerHTML = "";

    if (Array.isArray(r.ingredientes)) {
        r.ingredientes.forEach(ing => {
            const li = document.createElement("li");
            li.className = "list-group-item";
            li.textContent = `${ing.nombre} — ${ing.cantidad} ${ing.unidad || ""}`;
            listaIng.appendChild(li);
        });
    }

    // Pasos
    const listaPasos = document.getElementById("listaPasos");
    listaPasos.innerHTML = "";

    if (Array.isArray(r.pasos)) {
        r.pasos.forEach((p, i) => {
            const d = document.createElement("div");
            d.className = "mb-4";

            d.innerHTML = `
                <h6 class="fw-bold">Paso ${i + 1}</h6>
                <p>${p.instruccion || ""}</p>
                ${p.imagenUrl ? `<img src="${API_URL}/${p.imagenUrl}" class="img-fluid rounded mb-2">` : ""}
                ${p.videoUrl ? `<video controls class="w-100"><source src="${API_URL}/${p.videoUrl}"></video>` : ""}
            `;

            listaPasos.appendChild(d);
        });
    }
}

// ==========================================
// BOTÓN: AGREGAR A LA LISTA DE COMPRAS
// ==========================================
function activarBotonAgregar(receta) {
    const btn = document.getElementById("agregarLista");

    btn.addEventListener("click", () => {
        const lista = JSON.parse(localStorage.getItem("listaCompras")) || [];

        if (Array.isArray(receta.ingredientes)) {
            lista.push(...receta.ingredientes);
        }

        localStorage.setItem("listaCompras", JSON.stringify(lista));

        btn.textContent = "Agregado ✓";
        btn.classList.add("btn-success");
        setTimeout(() => {
            btn.textContent = "Agregar a la lista de compras";
            btn.classList.remove("btn-success");
        }, 2000);
    });
}

// ==========================================
// ERROR
// ==========================================
function mostrarError(msg) {
    document.getElementById("tituloReceta").textContent = "Error";
    document.getElementById("descripcionReceta").textContent = msg;
}